<!DOCTYPE html>
<html>
<head>
  <title>Vishwa-BitMart BTC Price - 5 Min Updates</title>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial; padding: 20px; }
    .alert { margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    #alerts { max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    .entry { margin-bottom: 10px; }
    .time-stamp { color: gray; font-size: 0.9em; }
  </style>
</head>
<body>
  <h2>ðŸ’° Live BTC Price on BitMart (Every 5 Mins)</h2>
  <div id="alerts">Loading...</div>

  <script>
    const url = 'https://corsproxy.io/?https://api-cloud.bitmart.com/spot/v1/ticker?symbol=BTC_USDT';
    const csvFileName = 'Crypto_BTC.csv';
    let lastPrice = null;
    let lastVolume = null;

    function fetchBTCPrice() {
      fetch(url)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('alerts');
          const ticker = data.data.tickers[0];

          // Get the current time in IST
          const now = new Date();
          const istTime = now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" });
          const [dateStr, timeStr] = istTime.split(", ");

          // Calculate differences
          const priceDifference = lastPrice ? (parseFloat(ticker.last_price) - lastPrice).toFixed(2) : "0.00";
          const volumeDifference = lastVolume ? (parseFloat(ticker.quote_volume_24h) - lastVolume).toFixed(2) : "0.00";

          // Save last values
          lastPrice = parseFloat(ticker.last_price);
          lastVolume = parseFloat(ticker.quote_volume_24h);

          // Append new entry
          const entry = document.createElement('div');
          entry.className = 'entry';
          entry.innerHTML = `
            <div><strong>BTC/USDT Price:</strong> $${ticker.last_price} (Diff: ${priceDifference})</div>
            <div><strong>24h Volume:</strong> ${ticker.quote_volume_24h} (Diff: ${volumeDifference})</div>
            <div class="time-stamp">ðŸ•’ Updated at (IST): ${dateStr} ${timeStr}</div>
          `;
          container.prepend(entry);

          // Write to CSV
          writeToCSV(ticker.last_price, ticker.quote_volume_24h, dateStr, timeStr, priceDifference, volumeDifference);
        })
        .catch(err => {
          console.error("Failed to load data:", err);
        });
    }

    function writeToCSV(value, volume, date, time, priceDiff, volumeDiff) {
      const data = `${value},${volume},${date},${time},${priceDiff},${volumeDiff}\n`;
      const blob = new Blob([data], { type: 'text/csv' });
      
      // Save as a download
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = csvFileName;
      link.click();
    }

    // Initial fetch
    fetchBTCPrice();

    // Fetch every 5 minutes (300000 ms)
    setInterval(fetchBTCPrice, 300000);

  </script>
</body>
</html>
